<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>
  <button onclick="emitFetch();">
    emitFetch
  </button>
  <button onclick="postMessage('token-renewed');">
    postMessage('token-renewed')
  </button>
  <button onclick="session.expired = true;">
    set token expired
  </button>
  <script>
    // Implementation
    const fetchApiFactory = (session) => (...args) => {
      if (!session.expired) {
        return fetch.apply(this, args);
      }
      return new Promise((res, rej) => {
        const handler = e => {
          console.log(e, 'test');
          session.expired = false;
          window.removeEventListener('message', handler);
          res(fetch.apply(this, args));
        };
        window.addEventListener('message', handler);
      });
    };

    // mock session
    let session = {
      expired: true,
      value: 'my-token',
    };

    // pre-action fetch
    const fetchApi = fetchApiFactory(session);

    // test-case
    const emitFetch = () => {
      const url = `/api/${new Date().getTime()}`;
      fetchApi(url).then(resp => console.log(`${new Date().getTime()}`, url));
      console.log(`fetchApi invoked: ${url}`);
    };
  </script>
</body>
</html>
