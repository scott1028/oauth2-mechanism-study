<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body>
  <div>
    <div>Normally this iframe should be hidden!</div>
    <!-- <iframe id="refresh_token_handler" src="authentication-server-refresh-token-page.html"></iframe> -->
  </div>
  <button onclick="doRefresh();">Renew Access Token by Silent Refresh Way</button>
  <script>
    // Module: SPA only can execute this once.
    const initTokenRefresher = (src, timeout = 5000, success = e => console.log(e), error = e => console.log(e)) => {
      let config;
      config = {
        onmessage(e) {
          switch(e.data.type) {
            case 'TOKEN-RENEWED':
              this.iframe.remove();
              clearTimeout(this.timeoutId);
              success(e.data);
              break;
            case 'RENEW-TIMEOUT':
              this.iframe.remove();
              error(e.data);
              break;
            default:
              console.log(e);
              break;
          }
          window.removeEventListener('message', this.onmessage);
          this.running = false;
        },
        running: false,
      };
      config.onmessage = config.onmessage.bind(config);
      return {
        perform: () => {
          if (config.running) {
            return console.log(`running: ${config.running}`);
          }
          config.running = true;
          window.addEventListener('message', config.onmessage);
          document.querySelector('#refresh_token_handler')
          const iframe = document.createElement('iframe');
          iframe.id = 'token-handler';
          iframe.src = src;
          document.body.append(iframe);
          config.iframe = iframe;
          config.timeoutId = setTimeout(() => postMessage({ type: 'RENEW-TIMEOUT' }), timeout);
        },
      }
    };

    // Usage
    const { perform, withdraw } = initTokenRefresher('/authentication-server-refresh-token-page.html', 5000);

    const doRefresh = () => {
      perform();
    }

  </script>
</body>
</html>
